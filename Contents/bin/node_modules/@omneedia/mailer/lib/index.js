/*
 *
 * Omneedia Mailer Library
 * version 1.1.0
 * Copyright (c) 2014-2018 Omneedia
 *
 */

process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";

sendmail = function (data, cb) {
    if (!global.settings.mail) return cb("NO_MAIL_SETTINGS", false);
    if (global.settings.mail.type == "mailgun") {
        var mailgun = require('mailgun-js');
        var options = {
            apiKey: global.settings.mail.auth.api_key,
            domain: global.settings.mail.auth.domain
        };
        if (global.CFG) {
            if (global.CFG.current) {
                if (global.CFG.current.proxy) {
                    options.proxy = global.CFG.current.proxy
                }
            }
        };
        console.log(data);
        if (process.env.proxy) options.proxy = process.env.proxy;
        var mailgun = Mail.using('mailgun-js')(options);
        mailgun.messages().send(data, function (error, body) {
            cb(error, body);
        });
        return;
    };

    if (global.settings.mail.type == "smtp") {
        var nodemailer = require('nodemailer');
        var transporter = nodemailer.createTransport(global.settings.mail);
        transporter.sendMail(data, cb);
        return;
    };

    return cb("MAIL_TYPE_NOT_FOUND");

};

exports.send = sendmail;